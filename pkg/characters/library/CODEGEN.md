# Character Code Generation

This directory uses **automatic code generation** to maintain character definitions. All character files and theme mappings are generated from `constants.go`.

## Quick Start

### Renaming a Character

To rename a character (e.g., "ga" → "gabe"):

1. **Edit `constants.go`:**
   ```go
   CharacterGa = "gabe"  // Changed from "ga"
   ```

2. **Regenerate:**
   ```bash
   make generate
   ```

3. **Verify and commit:**
   ```bash
   make test
   git add .
   git commit -m "Rename ga to gabe"
   ```

That's it! The following files are automatically updated:
- `gabe.go` (renamed from `ga.go`)
- `themes_generated.go` (all theme mappings)

### Adding a New Character

1. **Add to `constants.go`:**
   ```go
   const (
       CharacterSa = "sam"
       CharacterRi = "rio"
       // ... existing characters ...
       CharacterNew = "newchar"  // Add this
   )

   const (
       ColorSa = "#FF0000"
       ColorRi = "#FF8800"
       // ... existing colors ...
       ColorNew = "#ABCDEF"  // Add this
   )

   // Add to all 4 theme blocks:
   const (
       Theme1ColorSa = "#FF0000"
       // ...
       Theme1ColorNew = "#ABCDEF"  // Add this
   )
   // Repeat for Theme2, Theme3, Theme4
   ```

2. **Regenerate:**
   ```bash
   make generate
   ```

3. **New character file `newchar.go` is created automatically!**

## Architecture

### Source of Truth

**`constants.go`** is the single source of truth. It defines:
- Character names (`CharacterSa = "sam"`)
- Base colors (`ColorSa = "#FF0000"`)
- Theme colors (`Theme1ColorSa`, `Theme2ColorSa`, etc.)

### Generated Files

The following files are **auto-generated** (marked with `// Code generated` header):

- `sam.go`, `rio.go`, `ga.go`, `ma.go`, `pa.go`, `da.go`, `ni.go` - Character files
- `themes_generated.go` - Theme registration

**DO NOT EDIT THESE FILES MANUALLY!** Your changes will be overwritten.

### Hand-Written Files

These files are NOT generated (safe to edit):

- `constants.go` - **Edit this to change character names/colors**
- `library.go` - Core types and registry
- `generator.go` - GenerateFromRegistry() logic
- `themes.go` - Theme API (GetTheme, ListThemes, etc.)
- State registry JSON files - Animation frames

## How It Works

```
constants.go (edit this)
    ↓
generator_codegen.go (parses constants)
    ↓
Generates:
    - Character files (sam.go, rio.go, etc.)
    - themes_generated.go
```

### Generation Process

1. **Parser** reads `constants.go` using Go's AST parser
2. **Extracts** character names, colors, and theme mappings
3. **Validates** completeness (all characters in all themes)
4. **Generates** Go code from templates
5. **Formats** output with `go fmt`

## Commands

### `make generate`
Generates all character files from constants.go.

**When to run:**
- After changing character names in constants.go
- After adding/removing characters
- After changing colors

**Output:**
```
Generating character files from constants...
Generated sam.go
Generated rio.go
...
Generated themes_generated.go
✓ Generated 7 character files + themes
```

### `make verify-generate`
Verifies that generated files are up-to-date.

**When to run:**
- In CI/CD pipelines
- Before committing changes
- To check if you need to run `make generate`

**Output if up-to-date:**
```
Verifying generated code...
✓ Generated code is up-to-date
```

**Output if stale:**
```
Verifying generated code...
Generated files are out of date: sam.go: files differ

Run: make generate
```

### `make test`
Runs all tests **and** verifies generated code is up-to-date.

**Note:** Tests will fail if generated files don't match constants.go

## Files Reference

### Core Files

| File | Purpose | Edit? |
|------|---------|-------|
| `constants.go` | Single source of truth | ✅ YES |
| `generator_codegen.go` | Code generator script | ✅ YES (if changing generation logic) |
| `sam.go`, `rio.go`, etc. | Character definitions | ❌ NO (generated) |
| `themes_generated.go` | Theme registration | ❌ NO (generated) |
| `themes.go` | Theme API | ✅ YES |
| `library.go` | Core types | ✅ YES |
| `generator.go` | Runtime generation | ✅ YES |

### Generated File Structure

**Character file (e.g., `sam.go`):**
```go
// Code generated by generator_codegen.go; DO NOT EDIT.

package library

func init() {
	register(GenerateFromRegistry(CharacterMetadata{
		Name:        CharacterSa,    // Uses constant
		Description: "sam - Musical note avatar (Red)",
		Author:      "Wildreason, Inc",
		Color:       ColorSa,         // Uses constant
		Width:       11,
		Height:      4,
	}))
}
```

**Key differences from manual version:**
- `Name: CharacterSa` instead of `Name: "sam"`
- `Color: ColorSa` instead of `Color: "#FF0000"`
- Header comment indicates it's generated

## Troubleshooting

### Error: "Generated files are out of date"

**Cause:** You edited constants.go but didn't regenerate.

**Fix:**
```bash
make generate
```

### Error: "duplicate character name: sam"

**Cause:** constants.go has duplicate character definitions.

**Fix:** Check constants.go for duplicate `Character*` constants.

### Error: "theme bright has 6 characters, expected 7"

**Cause:** A character is missing from one of the theme blocks.

**Fix:** Add the missing `Theme*Color*` constant for the character.

### Error: "invalid color for sam: #ZZZ"

**Cause:** Invalid hex color code.

**Fix:** Use valid 6-digit hex color (e.g., `#FF0000`).

### Character file not generated after rename

**Cause:** Old character file still exists.

**Fix:**
```bash
# Remove old file
rm pkg/characters/library/oldname.go

# Regenerate
make generate
```

### Tests fail after generation

**Cause:** Generated code doesn't compile or breaks expectations.

**Fix:**
1. Check `make verify-generate` passes
2. Run `go build ./pkg/characters/library`
3. Check for import cycles or syntax errors

## Best Practices

### ✅ DO

- Edit only `constants.go` to change character names
- Run `make generate` after editing constants.go
- Run `make test` before committing
- Commit generated files along with constants.go changes

### ❌ DON'T

- Edit generated files (sam.go, rio.go, themes_generated.go)
- Manually create character files
- Skip running `make generate` after changing constants
- Commit constants.go changes without regenerating

## Development Workflow

### Standard Character Change

```bash
# 1. Edit
vim pkg/characters/library/constants.go

# 2. Generate
make generate

# 3. Test
make test

# 4. Commit
git add pkg/characters/library/
git commit -m "Rename character ga to gabe"
```

### Adding Multiple Characters

```bash
# 1. Add all new character constants to constants.go
# 2. Add colors for all 4 themes
# 3. Generate
make generate

# 4. Test
make test

# 5. Commit
git add pkg/characters/library/
git commit -m "Add new characters: foo, bar, baz"
```

## CI/CD Integration

The `make test` command includes `verify-generate` as a prerequisite:

```makefile
test: verify-generate
	@go test ./...
```

This ensures:
- Generated code is always up-to-date
- PRs can't be merged with stale generated files
- Developers are reminded to run `make generate`

## Technical Details

### Parser

Uses Go's standard library:
- `go/parser` - Parse constants.go
- `go/ast` - Extract constant values
- `go/token` - Handle source positions

### Templates

Uses `text/template` for code generation:
- Character file template (~12 lines)
- Theme file template (~60 lines)

### Validation

Pre-generation checks:
- All characters have colors in all themes
- No duplicate character names
- Valid hex color format (#RRGGBB)
- Character names are valid Go identifiers

Post-generation checks:
- Generated files compile
- Files match byte-for-byte in verify mode

## FAQ

**Q: Why generate instead of manual files?**
A: Character files are repetitive (12 lines each). Generation ensures consistency and makes renaming trivial (1 line change instead of 12+ files).

**Q: Can I customize a single character?**
A: Not with the current system. All characters share the same structure. If you need custom behavior, modify the template in `generator_codegen.go`.

**Q: What if I need to add a field to CharacterMetadata?**
A: Update the template in `generator_codegen.go` and regenerate.

**Q: How fast is generation?**
A: < 1 second. Fast enough to run on every build.

**Q: Are generated files checked into git?**
A: Yes. This is standard Go practice (see `//go:generate` in stdlib).

## See Also

- [Go generate documentation](https://go.dev/blog/generate)
- [Tangent README](../../../README.md)
- [Character API docs](../../../docs/API.md)
